check {
  test_qsort_r.sh
  test_pthread.sh
  test_symbol.sh { CLOCK_MONOTONIC time.h IW_HAVE_CLOCK_MONOTONIC }
}

set {
  LDFLAGS
  -lm
  if { defined { PTHREAD_LFLAG }
    ${PTHREAD_LFLAG}
  }
  if { defined { SYSTEM_ANDROID }
    -llog
  }
  if { eq { ${SYSTEM_ARCH} mips }
    if { library { LIB_ATOMIC atomic atomic.so.1 libatomic.so.1 }
      -l ${LIB_ATOMIC}
    }
  }
  ..${LDFLAGS}
}

set {
  LDFLAGS_TEST
  ${LIBIOWOW_A}
  @{ ${PKGCONF} --libs cunit }
  ..${LDFLAGS}
}

option { IOWOW_PUBLIC_HEADERS_DESTINATION  Installation path relative to INSTALL_PREFIX for iowow public header files. }
if { !defined { IOWOW_PUBLIC_HEADERS_DESTINATION }
  set {
    IOWOW_PUBLIC_HEADERS_DESTINATION ^{ ${INSTALL_INCLUDE_DIR} / ${META_NAME} }
  }
}

set {
  SOURCES
  iowow.c
}

set {
  PUB_HDRS
  basedefs.h
  iowow.h
}

configure {
  iwcfg.h.in
}

configure {
  libiowow.pc.in
}

include { fs/Autark }
include { json/Autark }
include { kv/Autark }
include { log/Autark }
include { platform/Autark }
include { rdb/Autark }
include { re/Autark }
include { utils/Autark }

cc {
  ${SOURCES}
  ${CFLAGS}
  ${CC}
  consumes {
    iwcfg.h
  }
}

set {
  LIBIOWOW_A
  CC { libiowow.a }
}

run {
  exec { ${AR} rcs ${LIBIOWOW_A} ${CC_OBJS} }
  consumes {
    ${CC_OBJS}
  }
  produces {
    ${LIBIOWOW_A}
  }
}

install { ${INSTALL_LIB_DIR} ${LIBIOWOW_A} }

if { ${IOWOW_BUILD_SHARED_LIBS}
  set {
    LIBIOWOW_SO_BASE
    libiowow.so
  }

  set {
    LIBIOWOW_SO_BIN
    ^{${LIBIOWOW_SO_BASE} . ${META_VERSION}}
  }

  set {
    LIBIOWOW_SO_NAME
    ^{${LIBIOWOW_SO_BASE} . ${META_VERSION_MAJOR}}
  }

  run {
    exec { ${CC} -shared -o ${LIBIOWOW_SO_BIN} ${CC_OBJS} }
    consumes {
      ${CC_OBJS}
    }
    produces {
      ${LIBIOWOW_SO_BIN}
    }
  }
  run {
    exec { ln -sf ${LIBIOWOW_SO_BIN} ${LIBIOWOW_SO_NAME} }
    exec { ln -sf ${LIBIOWOW_SO_BIN} ${LIBIOWOW_SO_BASE} }
    consumes {
      ${LIBIOWOW_SO_BIN}
    }
  }

  install { ${INSTALL_LIB_DIR} ${LIBIOWOW_SO_BIN} ${LIBIOWOW_SO_NAME} ${LIBIOWOW_SO_BASE} }
}

install { ${INSTALL_PKGCONFIG_DIR} libiowow.pc }
install { ${IOWOW_PUBLIC_HEADERS_DESTINATION} ${PUB_HDRS} }